name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  docker-build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - env: { COQ_VERSION: "8.20", DOCKER_MATHCOMP_VERSION: "2.4.0" }

    runs-on: ubuntu-latest
    env: ${{ matrix.env }}
    name: ${{ matrix.env.COQ_VERSION }}

    concurrency:
      group: ${{ github.workflow }}-${{ matrix.env.COQ_VERSION }}-${{ github.head_ref || github.run_id }}
      cancel-in-progress: true

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: coq-community/docker-coq-action@v1
        with:
          custom_image: mathcomp/mathcomp:${{ matrix.env.DOCKER_MATHCOMP_VERSION }}-coq-${{ matrix.env.COQ_VERSION }}
          export: CI
          custom_script: |
            eval $(opam env)
            sudo chmod -R a=u .
            # Work around https://github.com/actions/checkout/issues/766
            git config --global --add safe.directory "*"

            echo '::group::install dependencies'
            opam repo add coq-released https://coq.inria.fr/opam/released
            opam repo add rocq-released https://rocq-prover.org/opam/released
            opam update

            # Pins compatible with MathComp-Analysis 1.13 on Coq 8.20 + MC 2.4
            opam install -y -v \
              coq-elpi.2.6.0 \
              coq-hierarchy-builder.1.8.1 \
              coq-mathcomp-ssreflect.2.4.0 \
              coq-mathcomp-algebra.2.4.0 \
              coq-mathcomp-fingroup.2.4.0 \
              coq-mathcomp-solvable.2.4.0 \
              coq-mathcomp-field.2.4.0 \
              coq-mathcomp-finmap.2.2.1 \
              coq-mathcomp-bigenough.1.0.2 \
              coq-mathcomp-analysis.1.13.0 \
              coq-mathcomp-algebra-tactics.1.2.7 \
              coq-mathcomp-zify.1.5.0+2.0+8.16 \
              coq-flocq.4.2.1 coq-interval.4.11.3 coq-coquelicot.3.4.4 \
              coq-vcfloat.2.3 coq-compcert.3.15 coq-vst.2.15 coq-vst-lib.2.15.1
            echo '::endgroup::'

            make -j2
